---
title: "Lady Tasting Tea Lineups for Visual Inference"
author: "Karsten Maurer"
# institute: "Miami University"
date: "July 31, 2019"
output:
  xaringan::moon_reader:
    css: [default, "Miami_theme.css"]
    lib_dir: libs
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

### Lady Tasting Tea <sup>1</sup>

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(tidyverse)
library(teaTasteR)
```


```{r, out.width = "320px", echo=FALSE}
knitr::include_graphics("https://upload.wikimedia.org/wikipedia/commons/thumb/3/37/Nice_Cup_of_Tea.jpg/1280px-Nice_Cup_of_Tea.jpg")
```

.footnote[
[1] Fisher, R. A. (1960)
]

- Ronald Fisher and Muriel Bristol working at Rothamsted

- Claimed she could tell if tea or milk added first

--
- Blind taste test: four milk first, four tea first

- Fisher's Exact Test  $\rightarrow$ follows hypergeometric if guessing


???

Image credit: [Wikimedia Commons](https://commons.wikimedia.org/wiki/File:Sharingan_triple.svg)

---

### Lineups 

```{r, echo=FALSE, fig.align='center', out.height=380, fig.cap='Can the witness pick the criminal out of a randomized lineup of people?'}
knitr::include_graphics("https://upload.wikimedia.org/wikipedia/commons/0/04/Oppstilling-2.jpg")
```

???

Image credit: [Wikimedia Commons](https://upload.wikimedia.org/wikipedia/commons/0/04/Oppstilling-2.jpg)


---

### Lineups (for Visual Inference) <sup>2</sup>

.footnote[
[2] Buja, A., Cook, D., Hofmann, H., Lawrence, M., Lee, E. K., Swayne, D. F., & Wickham, H. (2009)
]


```{r, echo=FALSE, fig.align='center', fig.width=9, fig.height=6, out.height=380,out.width=570,  cache=TRUE, fig.cap='Can the statistician pick the real data out of a randomized lineup of data simulated under the null?'}
set.seed(12345)
M=19
diamond_samp <- sample_n(diamonds,500)
order_types = sample(c(rep("null",  M),"real"), M+1)
dat_stacked = NULL
    for (i in 1:(M+1)) {
        if (order_types[i] == "null"){
          dat_i = make_null_dat(dat=diamond_samp,xname = "carat",yname="price")
        }  
        if (order_types[i] == "real"){
          dat_i = data.frame(x=diamond_samp$carat,
                             permy=diamond_samp$price,
                             type="real")
        } 
        dat_i$order = i
        dat_stacked = rbind(dat_stacked, dat_i)
    }   
tt_lineup_plot(dat_stacked) +
  theme(panel.spacing = unit(.2, "lines"),
        strip.text=element_text(size=14))
```
---

### Lineups (for Visual Inference)


- Plot of real data hidden in set of K-1 plots of data generated under null model
<br><br>

--
#### Lineup Interpretations - One Viewer

- If a viewer can pick out the real data (p-value=1/K) $\rightarrow$ reject the null

- If a viewer can't pick out the real data (p-value=1) $\rightarrow$ fail to reject the null
<br><br>

--
#### Lineup Interpretations - Many Viewers

- Each person attempts to pick out real data

- Sum of correct guesses distributed Binomial(n,1/K) if viewers independent

---

### Our Work

- Research Team: George Woodbury, Seonjin Kim and myself

- Work started with George's masters project improving visual inference with one person

- After masters, George came back with a new idea...

-- 
#### Mashup: Tea Tasting + Lineup Plots

- Applying experimental design from the lady tasting tea

- Randomized lineup of with multiple null and *multiple* target plots

- Target plots need random perturbation of real data to avoid facsimile issues

- Viewer (*tea-taster*) tasked with classifying plots into two sets

???

"The Lady Tasting Tea" by David Salsburg
---
class: center, middle

# Methods

```{r, include=FALSE}
#------------------------------------
### make plot building walkthrough with faithful data

set.seed(123)
examplePlotBuild1 <- faithful %>%
  mutate(type="Original") %>%
  sample_n(100)%>%
  select(eruptions,waiting,type)

examplePlotBuild2 <- examplePlotBuild1 %>%
  mutate(type="LOESS Fitted")%>%
  mutate(type = factor(type,levels=c("Original","LOESS Fitted","Residuals Permuted")))%>%
  select(eruptions,waiting,type)

set.seed(123)
examplePlotBuild3 <- examplePlotBuild1 %>%
  make_alt_dat(xname="waiting",yname="eruptions") %>%
  mutate(type="Residuals Permuted") %>%
  mutate(waiting=x, 
         eruptions=permy)%>%
  select(waiting,eruptions,type)

examplePlotBuild4 <- examplePlotBuild3 %>%
  mutate(type="Target Plot")


examplePlotBuild2alt <- examplePlotBuild2 %>% 
  mutate(type="LOESS Fit then Residuals Permuted",
         type=factor(type,levels=c("Original","LOESS Fit then Residuals Permuted","Target Plot")))
exampleTargetPlotBuild <- rbind(examplePlotBuild1,examplePlotBuild2alt,examplePlotBuild4) %>%
  mutate(type = factor(type,levels=c("Original","LOESS Fit then Residuals Permuted","Target Plot")),
         plottype = "Target Plot Construction", 
         permx=NA,permy=NA)
exampleTargetPlotBuild$permx[exampleTargetPlotBuild$type == "LOESS Fit then Residuals Permuted"] <- examplePlotBuild4$waiting
exampleTargetPlotBuild$permy[exampleTargetPlotBuild$type == "LOESS Fit then Residuals Permuted"] <- examplePlotBuild4$eruptions

# permute the x and y to get final plot
exampleNullPlotBuild3 <- examplePlotBuild1 %>%
  make_null_dat(xname="waiting",yname="eruptions") %>%
  mutate(type="Null Plot") %>%
  mutate(waiting=x,
         eruptions=permy)%>%
  select(waiting,eruptions,type)

# add dataset to visualize this permutation in between by adding together original (x,y) and new (x,y) columns
exampleNullPlotBuild2 <- examplePlotBuild1 %>%
  mutate(type="Permutation")
# nulldat <- data.frame(waiting=NA,eruptions=NA,type="No More")

exampleNullPlotBuild <- rbind(examplePlotBuild1,exampleNullPlotBuild2,exampleNullPlotBuild3) %>%
  mutate(type = factor(type,levels=c("Original","Permutation","Null Plot")),
         plottype = "Null Plot Construction",
         permx=NA,permy=NA)
exampleNullPlotBuild$permx[exampleNullPlotBuild$type == "Permutation"] <- exampleNullPlotBuild3$waiting
exampleNullPlotBuild$permy[exampleNullPlotBuild$type == "Permutation"] <- exampleNullPlotBuild3$eruptions

```

---
### Generating Null Plots for Tea-Tasting Lineups

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=10,fig.height=7, cache=TRUE}
p2 <- ggplot() +
  geom_point(aes(x=waiting,y=eruptions), data=exampleNullPlotBuild) +
  geom_segment(aes(x=waiting,y=eruptions, xend=permx, yend=permy),data=exampleNullPlotBuild,
               arrow = arrow(length = unit(0.2,"cm")), alpha=.2) +
  scale_y_continuous(position = "right")+
  facet_grid(plottype~type, scales="free_x", switch="y") +
  theme_bw()+
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        strip.text = element_text(size=12))

ggsave(file="MakingNullPlots.png",dpi=600,
       width=10, height=5,units="in")

knitr::include_graphics("MakingNullPlots.png")

```

---
### Generating Target Plots for Tea-Tasting Lineups

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=10,fig.height=7, cache=TRUE}
p1 <- ggplot() +
  geom_point(aes(x=waiting,y=eruptions), data=exampleTargetPlotBuild) +
  geom_segment(aes(x=waiting,y=eruptions, xend=permx, yend=permy),data=exampleTargetPlotBuild,
               arrow = arrow(length = unit(0.2,"cm")), alpha=.2) +
  facet_grid(plottype~type, scales="free_x", switch="y") +
  scale_y_continuous(position = "right")+
  stat_smooth(aes(x=waiting,y=eruptions), data=examplePlotBuild2alt, se=F) +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        strip.text = element_text(size=12))

ggsave(file="MakingTargetPlots.png",dpi=600,
       width=10, height=5,units="in")

knitr::include_graphics("MakingTargetPlots.png")
```


---
### Example Tea Tasting Lineup

```{r,echo=FALSE,fig.width=9, fig.height=6, out.height=500,out.width=750, fig.align='center', cache=TRUE}
p4 <- tt_lineup_plot(make_lineup_dat(M=8, dat=sample_n(faithful,50), xname="waiting", yname="eruptions", seed=12345))+
  theme(panel.spacing = unit(.2, "lines"),
        strip.text=element_text(size=14))

ggsave(file="faithful_lineup.png",dpi=600,
       width=9, height=6,units="in")

knitr::include_graphics("faithful_lineup.png")
```
---
### Properties

- Looks similar to traditional lineup for visual inference

- p-values for single TT lineup evaluation are no longer binary

- p-values follow hypergeometric *if null and target plots indistinguishable for data generated by the null*

--

### Open Questions

1. Does the TT lineup have discriminative power in practice?

--

2. Are the TT lineup p-values hypergeometrically distributed?

--

3. How might the TT lineup compare to numerical tests?

---
### Survey

- Participants presented with eight TT lineups based on eight datasets 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=4, cache=TRUE}
# Set parameters for lineup and individual
cor_val=.9
participant_number = 1
M_pairs = 8

# load/simulate data here
library(mvtnorm)
n=50
set.seed(participant_number)
survey_order=sample(1:8)
sim_data <- list(NULL)
set.seed(2345)
sim_data[[1]] <- as.data.frame(mvtnorm::rmvnorm(n, mean=c(0,0), sigma=matrix(c(1,.6,.6,1),nrow=2,byrow=TRUE)))
sim_data[[2]] <- as.data.frame(mvtnorm::rmvnorm(n, mean=c(0,0), sigma=matrix(c(1,.3,.3,1),nrow=2,byrow=TRUE)))
sim_data[[3]] <- sim_curve(n=n, b0=0, b1=0, b2=.5, sd=2.6, range=c(-3,3))
sim_data[[4]] <- sim_curve(n=n, b0=0, b1=0, b2=.5, sd=1.4, range=c(-3,3))
sim_data[[5]] <- sample_n(faithful,n)
sim_data[[6]] <- sample_n(select(diamonds,carat,price),n)
sim_data[[7]] <- data.frame(x=rnorm(n), y=rnorm(n))
sim_data[[8]] <- data.frame(x=runif(n), y=runif(n))

simtype = c("Strong Linear","Weak Linear","Curved Weak","Curved Strong",
            "Old Faithful","Diamonds","Independent-Normal","Independent-Uniform")


for(i in 1:8){
  names(sim_data[[i]]) <- c("x","y")
  sim_data[[i]]$simtype <- simtype[i]
}

survey_dat <- do.call(rbind,sim_data) %>%
  mutate(simtype = factor(simtype, levels=c("Independent-Normal","Weak Linear","Strong Linear","Diamonds",
                                           "Independent-Uniform","Curved Weak","Curved Strong","Old Faithful")))

p5 <- ggplot() +
  geom_point(aes(x,y), data=survey_dat) +
  facet_wrap(~simtype, nrow=2, scales = "free") +
  theme_bw()+
  theme(axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank())

ggsave(file="survey_data.png",dpi=600,
       width=10, height=5,units="in")

knitr::include_graphics("survey_data.png")
```

---
### Survey

- Administration:

  + distributed to students and faculty of Miami University Stat Department
  + blinded drop-box for return
  
--

- Randomization: 

  + Datasets uniquely simulated/sampled for each survey
  + Random order of lineups on survey
  + Random plot ordering within lineups
  + Permutation step for each plot construction

--

- 45 participants completed all eight lineups 
  + 24 Undergrad, 14 Grad, 6 Faculty, 1 Unknown

---
class: center, middle

# Results

---
### 1. Does the TT lineup have discriminative power in practice?


---
### 2. Are the TT lineup p-values hypergeometrically distributed?

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=4, cache=TRUE}
load("graph_df.Rdata")
# wide to tall, scale to density values, clean labels
tall_dat <- graph_df %>%
  gather(key="type",value="value",expected:observed_normal) %>%
  group_by(type) %>%
  mutate(density = value/sum(value)) %>%
  ungroup() %>%
  mutate(distn_type= factor(type,labels=c("Hypergeometric","Observed - Ind Normal","Observed - Ind Uniform")))

# set aside observed distributions under uniform and normal generated data
observed_distn <- filter(tall_dat,distn_type!="Hypergeometric")%>%
  mutate(facet_frame = distn_type)
# make a version of the HG distn that will overlay into each facet frame
baseline_distn <- rbind(filter(tall_dat,distn_type=="Hypergeometric"),
                        filter(tall_dat,distn_type=="Hypergeometric"))
baseline_distn$facet_frame <- observed_distn$facet_frame

# faceted version of empirical distributions
p6 <- ggplot() + 
  geom_bar(aes(x=x, y=density, fill=distn_type, color=distn_type),
           size=1,alpha=.6, stat="identity",
           data=baseline_distn)  + 
  geom_bar(aes(x=x+.02, y=density, fill=distn_type, color=distn_type),
           size=1,alpha=.2, stat="identity", 
           data=observed_distn) +
  facet_grid(. ~ facet_frame ) +
  scale_fill_manual(values=c("gray80","red","blue")) +
  scale_color_manual(values=c("black","red","blue")) +
  labs(x="Number of Correct Responses",
       y="Probability Density",
       color=" ",fill=" ")+
  theme_bw()+
  theme(legend.position = "bottom")

ggsave(file="DensityComparisons.png",dpi=600,
       width=8, height=4,units="in")

knitr::include_graphics("DensityComparisons.png")
```


---
### 3. How might the TT lineup compare to numerical tests?


---
class: center, middle

# Thanks!

Slides created via the R package [**xaringan**](https://github.com/yihui/xaringan).

